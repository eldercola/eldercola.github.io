---
layout:     post
title:      推荐算法线下AUC提升明显，线上收益提升不明显该怎么办
subtitle:   推荐算法实验结果排查
date:       2024-01-04
author:     BY LinShengfeng
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - 算法
    - 推荐系统

---

# 前言

>当我们需要提升一个推荐系统的线上收益时，第一步往往是提升模型在离线数据集的测试效果。当我们发现模型在离线数据集有效果提升时，才会将它部署到线上，并与基线做线上A/B测试。在经过一段时间的A/B测试后，我们通过比较新模型与基线模型线上的ECPM收益来判断新模型是否具备更好的效果。接着我们常常会发现，新模型在离线数据集上表现很好，但是在线数据集中可能表现远远不如基线模型。

# 分析

遇到这种情况，可以从以下几个角度来找原因[1]：

1. 特征/数据发生穿越：数据方面，检查一下是不是使用了测试集的数据；特征方面，检查一下特征生成过程中是不是使用了测试集中的数据，此外，还需要检查一下是否存在与标签Label有强关联的特征。一般出现这种情况，离线的AUC能暴涨好几个点。
2. 线上线下特征不一致：线上推理时，用户的特征与离线时使用的不一致。一种是离线在线代码不统一，例如，有一个序列特征，离线训练时长度设置为50，但在线推理的序列特征长度最长被设置为30，这很容易导致模型在线上无法发挥正向作用。此外，也可能是数据不统一，假设有一个特征是统计过去30天的数据得到的，但是在线的特征只统计了过去7天的数据，这也容易导致模型效果负向。
3. 数据分布不一致：离线测试的数据分布与在线的数据分布不一致。具体表现为生成离线训练数据过程中，我们舍弃掉了一些样本，新模型训练过程中没拟合过这类样本，所以对这部分数据预测不准确。**具体可以见文献[1]**. 这种问题的解决对策之一是做新旧模型预估融合，即 $pCTR=k * pCTR_{new}+ (1 - k) * pCTR_{old}$, 刚上线的时候$k$先调小，然后慢慢迭代，慢慢放大。

# 引用

[1] [线下实验auc涨了，但是线上效果却不佳（ctr等指标没有涨）的原因](https://zhuanlan.zhihu.com/p/136535140)
